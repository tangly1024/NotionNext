name: Deploy NotionNext

on:
  schedule:
    - cron: '0 * * * *'  # æ¯ 30 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ§° Set up Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: ğŸ” Check Notion page hash and deploy if changed
        run: |
          mkdir -p .cache

          echo "ğŸ” Calculating current hash..."
          current_hash=$(curl -s https://notion-api.splitbee.io/v1/page/24ee6481ffbd80e299a8c77c37baf01b | md5sum | cut -d ' ' -f1)
          echo "$current_hash" > .cache/current.md5

          echo "ğŸ“¦ Fetching previous hash from GitHub..."
          curl -s -o .cache/previous.md5 https://raw.githubusercontent.com/ThereChenSnow/NotionNext/main/.cache/previous.md5

          if [ ! -s .cache/previous.md5 ]; then
            echo "âš ï¸ No previous hash found. Assuming first run. Skipping deploy."
            exit 0
          fi

          previous_hash=$(cat .cache/previous.md5)
          if [ "$current_hash" != "$previous_hash" ]; then
            echo "ğŸš€ Content changed. Triggering EdgeOne deploy..."
            curl -X POST https://pages-api.edgeone.ai/v1/webhook/32d294f9005676799bb75b8f806a098799f96995e80a9cd1c924f8515c3eba5e
          
            # æ›´æ–° previous.md5
            cp .cache/current.md5 .cache/previous.md5
            git add .cache/previous.md5
            git commit -m "ğŸ”„ Update previous.md5 after deploy"
            git push
          else
            echo "âœ… No content change. Skipping deploy."
          fi




